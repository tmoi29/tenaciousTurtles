import os

from flask import Flask, Response, render_template, request, session

from util.flask.flask_utils import form_contains, post_only, preconditions, reroute_to, \
    session_contains
from util.flask.flask_utils_types import Router
from util.flask.template_context import add_template_context, context
from utils import database

app = Flask(__name__, static_url_path='')

UID_KEY = 'uid'

is_logged_in = session_contains(UID_KEY)
is_logged_in.func_name = 'is_logged_in'
context[is_logged_in.func_name] = is_logged_in

is_not_logged_in = ~is_logged_in
is_not_logged_in.func_name = 'is_not_logged_in'
context[is_not_logged_in.func_name] = is_not_logged_in


@app.reroute_from('/')
@app.route('/index')
def index():
    # type: () -> Response
    return render_template('index.html', logged_in=is_logged_in())


@app.route('/login')
def login_page():
    # type: () -> Response
    if is_logged_in():
        return reroute_to(index)
    return render_template('login.html')


logged_in = preconditions(login_page, is_logged_in)  # type: Router
not_logged_in = preconditions(index, is_not_logged_in)  # type: Router


@app.route('/login_auth', methods=['get', 'post'])
@not_logged_in
@preconditions(login_page, post_only, form_contains('username', 'password'))
def login():
    # type: () -> Response
    session[UID_KEY] = True  # TODO
    form = request.form
    if not database.authenticate(form['username'], form['password']):
        return reroute_to(login_page)
    return reroute_to(index)


@app.route('/create_account')
@not_logged_in
def create_account_page():
    # type: () -> Response
    return render_template('create_account.html')


@app.route('/create_account_auth', methods=['get', 'post'])
@not_logged_in
@preconditions(create_account_page, post_only,
               form_contains('username', 'password1', 'password2'))
def create_account():
    # type: () -> Response
    form = request.form
    if not database.add_account(form['username'], form['password1'], form['password2']):
        return reroute_to(create_account_page)
    return reroute_to(login)


@app.route('/logout')
@logged_in
def logout():
    # type: () -> Response
    del session[UID_KEY]
    return reroute_to(index)

@app.route('/rest_info')
@not_logged_in
def info():
    # type: () -> Response
    return render_template('information.html')

if __name__ == '__main__':
    app.secret_key = os.urandom(32)
    add_template_context(app)
    app.run(debug=True)
